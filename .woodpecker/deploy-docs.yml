when:
  - event: [push, manual]
    branch: ${CI_REPO_DEFAULT_BRANCH}

steps:
  - name: build
    image: ghcr.io/astral-sh/uv:python3.12-bookworm-slim
    commands:
      - apt-get update && apt-get install -y git
      - uv sync
      - uv run mkdocs build -d site-build

  - name: deploy
      image: appleboy/drone-git-push
      settings:
        branch: pages
        remote: git@codeberg.org:sailorfe/ephem.git
        force: true
        commit: true
        commit_message: "Deploy: ${CI_COMMIT_SHA:0:7}"
        path: site-dist
        ssh_key:
          from_secret: deploy_ssh_key
        safe_directory: "*"
      environment:
        GIT_SSH_COMMAND: "ssh -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no"
      when:
        - branch: ${CI_REPO_DEFAULT_BRANCH}
